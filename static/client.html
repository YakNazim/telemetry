<!doctype html>
<html lang="en">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" media="screen" href="/static/css/style.css"/>
  <script src="/static/scripts/jquery.min.js"></script>
  <script src="/static/scripts/d3.v2.js"></script>
  <script src="/static/scripts/d3_func.js"></script>
  <script src="/static/scripts/js-yaml.min.js"></script>
  <script src="/static/scripts/quantities.js"></script>
  <script src="/static/scripts/units.js"></script>
  <script src="/static/widgets/widget.js"></script>
  <script src="/static/widgets/gauge.js"></script>
  <script src="/static/widgets/line_graph.js"></script>
  <script src="/static/widgets/text_widget.js"></script>
  <title>PSAS - Real Time Telemetry Visualization</title>
 </head>
 <body>

  <div id="wrapper">
   <div id="header">
    <a class="brand" href="/"><img src="/" alt="logo" width="40" height="40"></a>
    <ul class="tabs">
     <li><a href="/">Index</a></li>
     <li><a href="/?config=pack.yml">Packet Statistics</a></li>
     <li><a href="/?config=adis_config.yml">ADIS</a></li>
    </ul>
   </div>
   <div class="container"></div>
  </div>

  <div id="overlay">
  </div>
  <div id="msgBox">
    <h1 id="msg"></h1>
  </div>

 <script>

    // Websocket
    $(function () {  
        // if user is running mozilla then use it's built-in WebSocket
        window.WebSocket = window.WebSocket || window.MozWebSocket;
        var connection = new WebSocket('ws://'+ location.host +'/ws');

        connection.onopen = function () {
            connection.send('Client Connected');
        };
        connection.onerror = function (error) {
        };
        connection.onclose = function () {
            // Show lost connection message
            var overlay = document.getElementById('overlay');
            var msgBox = document.getElementById('msgBox');
            var msg = document.getElementById('msg');
            msg.innerHTML = 'POLL FAILURE';
            overlay.style.display = "block";
            msgBox.style.display = "block";
        };

        // A websocket message
        connection.onmessage = function (message) {
            // try to decode json
            try {
                var json = JSON.parse(message.data);
                if (json.fieldID != undefined) {
                    widgets.forEach(function(widget) {
                        widget.putJSON(json);
                    });
                }
            } catch (e) {
                console.log(e.toString());
                return;
            }
        };
    });

  function LoadFile(pathOfFileToRead){
    var request = new XMLHttpRequest();
    request.open("GET", pathOfFileToRead, false);
    request.send(null);
    var contentsOfFileAsString = request.responseText;
  
    return contentsOfFileAsString;
  }

  function loadConfigs() {
    var param = /[&?]config=([^&]+)/.exec(location.search);
    var d = new Date();
    var fileName = '/static/config/' + (param ? param[1] : 'config.yml')+'?'+d.getTime();
    return jsyaml.load(LoadFile(fileName));
  }
  
  function makeWidget(config) {
    switch(config.type) {
      case 'Text':
      return new TextWidget(config);
      case 'LineGraph':
      return new LineGraph(config);
      case 'Gauge':
      return new Gauge(config);
      case 'Layout':
      // Add columns
      $('.container').append(addColumns(config));
      return null;
      default:
      return null;
    }
  }

  /******* initialized widgets from config file passed in the 'config' query string param *******/
  var configs = loadConfigs();
    
  widgets = [];
  for (var i = 0; i < configs.length; i++) {
    var widget = makeWidget(configs[i]);
    if (widget != null) {
      widgets.push(widget);
    }
  };
  
  function addColumns(config) {
    var toAppend = '';
    
    config.columns.forEach(function(column) {
      // if stand alone column just add it
      if (typeof column.columns == 'undefined') {
        toAppend = toAppend + '<div id ="' + column.id + '" style="width:' + column.width + '; float:left; display:inline-block;"></div>';
      }
      // else traverse through nested columns
      else {
        toAppend = toAppend + '<div id ="' + column.id + '" style="width:' + column.width + '; float:left; display:inline-block;">';
        toAppend = toAppend + addColumns(column) + '</div>';
      }
    });
    
    return toAppend;
  }
</script>
 </body>

</html>

